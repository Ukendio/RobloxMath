# Taken from roblox-ts under the MIT license https://github.com/roblox-ts/roblox-ts/blob/master/.github/workflows/ci.yml

name: CI

on:
  pull_request:
  push:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2.3.4

      - name: Install Foreman
        uses: rojo-rbx/setup-foreman@v1.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Selene
        run: selene lib
  format:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2.3.4

      - name: Run StyLua check
        uses: JohnnyMorganz/stylua-action@1.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          args: --check lib
  unit-tests:
    name: Unit Tests
    runs-on: windows-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2.3.4

      - name: Install Roblox Studio
        uses: OrbitalOwen/roblox-win-installer-action@1.1
        with:
          # This cookie is intentionally public, because secrets are not available in pull request CI runs
          # It is from an empty account and not a security vulnerability
          cookie: ${{ secrets.ROBLOSECURITY || '_|WARNING:-DO-NOT-SHARE-THIS.--Sharing-this-will-allow-someone-to-log-in-as-you-and-to-steal-your-ROBUX-and-items.|_500EA931D8A86B243F1E7105CC476914E77C40BD78E81F4BA6A07D9265073268E011FDBB1DAF6E81377D524F25E43944C57C7C6EA4364B9290FA455D8F78BF36112947395477CE5820A36690176CED459EFDBD9A7EA1B24D84FB70AD361F67F22467068802A05C547FE9A2970A38ABAB64352B41DC82A8B97C378E2BAF53771833B626AFB66A4D37685AF2FB9FE32409350BD5AB4A3D4529C31095978E681AFA6E9A20056DE4E01F32F1D4C7E4BEDE56F5458F1AB19FE1FC02F77B6326641AC70D4A0751C9AB8AD89FF91B1B5700CE7A8D6668F9107A10E123A12784D7FE15AAC05EBD6A44BBC38607AE92BC5F593F0DBDB228D4A9C4752A5DD5ABE9F02A920B36F21D45E71B02DDEEAE76835E55855BA033EB960C82FAC00BBFC07FA69332EA7E54B269AEF664D1EF41B68A278E5FB237A9EAB754D3AF744A8F89CE3C03DA909C5B2B2622DB90D7B44217B81456C3167E80803CF16A9F305EE34E43E60A813D5793E5DF0DA2E1A3E207BA2F64572CCF35C9311A' }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Foreman
        uses: rojo-rbx/setup-foreman@v1.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build test place
        run: rojo build test.project.json -o test.rbxl

      - name: Run tests
        shell: bash
        run: run-in-roblox --place test.rbxl --script tests.server.lua > test-out.txt
        continue-on-error: true

      - name: Check test status
        shell: bash
        run: cat test-out.txt | grep "0 failed, 0 skipped" || (cat test-out.txt && exit 1)
