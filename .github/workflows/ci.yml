# Taken from roblox-ts under the MIT license https://github.com/roblox-ts/roblox-ts/blob/master/.github/workflows/ci.yml

name: CI

on:
  pull_request:
  push:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2.3.4

      - name: Install Foreman
        uses: rojo-rbx/setup-foreman@v1.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Selene
        run: selene lib
  format:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2.3.4

      - name: Run StyLua check
        uses: JohnnyMorganz/stylua-action@1.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          args: --check lib
  unit-tests:
    name: Unit Tests
    runs-on: windows-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2.3.4

      - name: Install Roblox Studio
        uses: OrbitalOwen/roblox-win-installer-action@1.1
        with:
          # This cookie is intentionally public, because secrets are not available in pull request CI runs
          # It is from an empty account and not a security vulnerability
          cookie: ${{ secrets.ROBLOSECURITY || '_|WARNING:-DO-NOT-SHARE-THIS.--Sharing-this-will-allow-someone-to-log-in-as-you-and-to-steal-your-ROBUX-and-items.|_597067C851A0BE257BB10744FEA4B2521D9E6F8BDD4FE1D1BE541F8E61FDE68D32F12D49B6C3B77D3466727927608D8067E4BFC51C13492B733AD930DE092D357D39FE49E443F409B151FBA4A8BC4710E4249B031333C231E4FB31698915D2F9E6596311BB790E49D0360AB5A4B86F9B3B70156A011E9BB85717FF12DEB18AF35A894313696721E8653C017F973D9C6BF54C3717008DDA2F2601FF50AD0F19C18714CFEFF926CC9EBC5BE812FB34A87641C297E24A5A1C3917C4F2E5C293AE0B6427F58AE9AFCE1230625A3B00188E2CECFB58758CA6A9EAE1F27B4334708D72A9A47A9E4219D195D2342FFFA718F69192C9C9D40F4001DA26739AC1CFD23B86DA1AAE600B78C11D64E521C6D8E495ABE2123F53F455C72E31DBA02C4B2B3B6B5C5F7A50047C8D345E8FB562CE91C072BEA4D54F502B480C356CA8AFEA3EE4E4D2DBB54F64DB64CE63016C1116B5FDBE15AB32DF4137D0EBE875CEB579598DD43EB5241657D6D8522D71C3EBFBC73022DB06D318' }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Foreman
        uses: rojo-rbx/setup-foreman@v1.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build test place
        run: rojo build test.project.json -o test.rbxl

      - name: Run tests
        shell: bash
        run: run-in-roblox --place test.rbxl --script tests.server.lua > test-out.txt
        continue-on-error: true

      - name: Check test status
        shell: bash
        run: cat test-out.txt | grep "0 failed, 0 skipped" || (cat test-out.txt && exit 1)
